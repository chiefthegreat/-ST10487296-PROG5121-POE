name: Java Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Create proper directory structure
      run: |
        # Create the package directory structure
        mkdir -p chatapp
        # Move all Java files to the chatapp package directory
        mv *.java chatapp/ 2>/dev/null || echo "No Java files in root to move"
        ls -la chatapp/
        
    - name: Download dependencies
      run: |
        # Download JUnit 4 and Gson
        wget -O junit-4.13.2.jar https://repo1.maven.org/maven2/junit/junit/4.13.2/junit-4.13.2.jar
        wget -O hamcrest-core-1.3.jar https://repo1.maven.org/maven2/org/hamcrest/hamcrest-core/1.3/hamcrest-core-1.3.jar
        wget -O gson-2.10.1.jar https://repo1.maven.org/maven2/com/google/code/gson/gson/2.10.1/gson-2.10.1.jar
        
    - name: Compile main application
      run: |
        javac -cp ".:gson-2.10.1.jar" chatapp/*.java
        echo "Main application compiled successfully"
        
    - name: Compile test classes
      run: |
        javac -cp ".:chatapp:gson-2.10.1.jar:junit-4.13.2.jar:hamcrest-core-1.3.jar" chatapp/*Test.java chatapp/*IT.java
        echo "Test classes compiled successfully"
        
    - name: Run individual test classes
      run: |
        echo "=== Running LoginTest ==="
        java -cp ".:chatapp:gson-2.10.1.jar:junit-4.13.2.jar:hamcrest-core-1.3.jar" org.junit.runner.JUnitCore chatapp.LoginTest || echo "LoginTest completed"
        
        echo "=== Running MessageIT ==="
        java -cp ".:chatapp:gson-2.10.1.jar:junit-4.13.2.jar:hamcrest-core-1.3.jar" org.junit.runner.JUnitCore chatapp.MessageIT || echo "MessageIT completed"
        
        echo "=== Running MessageManagerTest ==="
        java -cp ".:chatapp:gson-2.10.1.jar:junit-4.13.2.jar:hamcrest-core-1.3.jar" org.junit.runner.JUnitCore chatapp.MessageManagerTest || echo "MessageManagerTest completed"
        
    - name: Verify file structure
      run: |
        echo "=== Current directory structure ==="
        find . -name "*.java" -type f
        echo "=== Compiled classes ==="
        find . -name "*.class" -type f | head -20
